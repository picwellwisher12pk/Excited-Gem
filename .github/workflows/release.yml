name: "Build and Release Extension"

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Dependencies
        run: bun install

      - name: Build and Package
        # Build production unpacked first, then package it
        run: |
          bun run build
          bun run package
          ls -R build/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            build/chrome-mv3-prod.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Debug SUBMIT_KEYS
        env:
          SUBMIT_KEYS: ${{ secrets.SUBMIT_KEYS }}
        run: |
          if [ -z "$SUBMIT_KEYS" ]; then
            echo "::error::SUBMIT_KEYS secret is empty!"
            exit 1
          fi
          # Check if valid JSON and show keys (not values)
          echo "$SUBMIT_KEYS" | jq -r 'keys'
          echo "Structure check: $(echo "$SUBMIT_KEYS" | jq -r '.chrome | keys')"

          # Check for missing required fields in the chrome sub-object
          FIELDS=$(echo "$SUBMIT_KEYS" | jq -r '.chrome | keys | join(",")')
          MISSING=""
          [[ "$FIELDS" != *"extensionId"* ]] && MISSING+=" extensionId"
          [[ "$FIELDS" != *"clientId"* ]] && MISSING+=" clientId"
          [[ "$FIELDS" != *"clientSecret"* ]] && MISSING+=" clientSecret"
          [[ "$FIELDS" != *"refreshToken"* ]] && MISSING+=" refreshToken"

          if [ ! -z "$MISSING" ]; then
            echo "::error::SUBMIT_KEYS is missing the following fields in .chrome:$MISSING"
            exit 1
          fi

      - name: Browser Platform Publisher
        uses: plasmohq/bpp@v3
        with:
          keys: ${{ secrets.SUBMIT_KEYS }}
          zip: build/chrome-mv3-prod.zip
